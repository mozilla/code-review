# Generated by Django 5.1.1 on 2024-10-14 13:05

from django.conf import settings
from django.db import migrations
from django.db.models import OuterRef, Subquery
from tqdm import tqdm


def move_attributes(apps, schema_editor):
    """
    Update values for new attributes on IssueLink
    using source data from linked Issue
    """
    IssueLink = apps.get_model("issues", "IssueLink")
    Issue = apps.get_model("issues", "Issue")

    if settings.DATABASES["default"]["ENGINE"] == "django.db.backends.sqlite3":
        print("\nPerforming data migration in bulk with SQLite bacjend")
        IssueLink.objects.update(
            in_patch=Subquery(
                Issue.objects.filter(id=OuterRef("issue_id")).values("in_patch")[:1]
            ),
            new_for_revision=Subquery(
                Issue.objects.filter(id=OuterRef("issue_id")).values(
                    "new_for_revision"
                )[:1]
            ),
        )
        return

    total_count = Issue.objects.count()
    remaining_issues = (
        Issue.objects.filter(
            issue_links__in_patch__isnull=True,
            issue_links__new_for_revision__isnull=True,
        )
        # Skip what does not need to be updated
        .exclude(
            in_patch__isnull=True,
            new_for_revision__isnull=True,
        )
        .order_by("id")
        .distinct("id")
    )
    # Avoid overriding django line for the migration
    print()
    for issue in tqdm(
        remaining_issues.iterator(),
        initial=total_count - remaining_issues.count(),
        total=total_count,
    ):
        issue.issue_links.update(
            in_patch=issue.in_patch, new_for_revision=issue.new_for_revision
        )


def restore_attributes(apps, schema_editor):
    """Copy attributes in the reverse direction"""
    IssueLink = apps.get_model("issues", "IssueLink")
    total_count = IssueLink.objects.distinct("issue").count()
    qs = (
        IssueLink.objects.select_related("issue")
        .filter(issue__in_patch__isnull=True, issue__new_for_revision__isnull=True)
        .exclude(in_patch__isnull=True, new_for_revision__isnull=True)
        .distinct("issue")
    )
    # Avoid overriding django line for the migration
    print()
    for issue_link in tqdm(
        qs.iterator(), initial=total_count - qs.count(), total=total_count
    ):
        issue_link.issue.in_patch = issue_link.in_patch
        issue_link.issue.new_for_revision = issue_link.new_for_revision
        issue_link.issue.save()


class Migration(migrations.Migration):
    # Mark the migration as non atomic so it can be completed progressively
    atomic = False

    dependencies = [("issues", "0012_move_issues_attributes_part_1")]

    operations = [
        migrations.RunPython(
            move_attributes,
            reverse_code=restore_attributes,
        ),
    ]
